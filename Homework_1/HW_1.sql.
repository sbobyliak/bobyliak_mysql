CREATE DATABASE Rollerskating;
USE Rollerskating;

CREATE TABLE Rollers (
    roller_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    age INT,
    city VARCHAR(50)
);

INSERT INTO Rollers (name, age, city) VALUES
('Angelina', 19, 'Kyiv'),
('Vitaly', 22, 'Odesa'),
('Diana', 28, 'Kyiv'),
('Anastasia', 21, 'Odesa'),
('Yulia', 25, 'Kyiv'),
('Denis', 18, 'Odesa'),
('Oleksii', 24, 'Kyiv'),
('Neil', 22, 'Vinnytsia'),
('Oleh', 30, 'Kyiv'),
('Tina', 17, 'Vinnytsia');

CREATE TABLE Instructors (
    instructor_id INT AUTO_INCREMENT PRIMARY KEY,
    roller_id INT,
    experience INT,
    num_of_students INT,
    rating INT
);

INSERT INTO Instructors (roller_id, experience, num_of_students, rating) VALUES
(1, 2, 30, 4),
(2, 3, 15, 3),
(3, 5, 25, 3),
(7, 4, 34, 4),
(8, 5, 28, 5);

CREATE TABLE Communities (
    community_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    num_of_people INT,
    city VARCHAR(50)
);

INSERT INTO Communities (name, num_of_people, city) VALUES
('Uroll', 543, 'Kyiv'),
('Rollers-in-Odesa', 231, 'Odesa'),
('Vinnrollers', 86, 'Vinnytsia');

CREATE TABLE Shops (
    shop_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    city VARCHAR(50),
    partner_id INT
);

INSERT INTO Shops (name, city, partner_id) VALUES
('Rollerland', 'Kyiv', 1),
('Rollershop', 'Kyiv', 4),
('FlyingEagle', 'Kyiv', 3),
('Rollerblade', 'Odesa', 2),
('Myroller', 'Vinnytsia', 5);

CREATE TABLE Clients (
    client_id INT AUTO_INCREMENT PRIMARY KEY,
    shop_id INT,
    order_name VARCHAR(50)
);

INSERT INTO Clients (shop_id, order_name) VALUES
(1, 'Rollerblades'),
(2, 'Protection'),
(3, 'Rollerblades'),
(4, 'Equipment'),
(2, 'Protection'),
(1, 'Equipment'),
(5, 'Rollerblades');

WITH Client_count AS (
    SELECT shop_id, COUNT(*) AS num_of_clients
    FROM Clients
    GROUP BY shop_id
)

SELECT 
    r.name AS roller_name, r.age, r.city,
    i.experience, i.num_of_students, i.rating,
    cm.name AS community,
    s.name AS shop,
    COALESCE(cc.num_of_clients, 0) AS num_of_clients
FROM Instructors i
JOIN Rollers r ON r.roller_id = i.roller_id
LEFT JOIN Shops s ON s.partner_id = i.instructor_id
LEFT JOIN client_count cc ON cc.shop_id = s.shop_id
LEFT JOIN Communities cm ON r.city = cm.city
WHERE i.rating >= (
	SELECT AVG(rating) 
	FROM Instructors)
GROUP BY  r.name, r.age, r.city, i.experience, i.num_of_students, i.rating, cm.name, s.name, num_of_clients
HAVING num_of_clients > 0
ORDER BY num_of_clients DESC, roller_name
LIMIT 2;
